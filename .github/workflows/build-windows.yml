name: Build ARKIVE Desktop for Windows

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Enable Git long paths
      run: git config --global core.longpaths true
      
    - name: Enable Windows long paths support
      run: |
        New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" `
          -Name "LongPathsEnabled" -Value 1 -PropertyType DWORD -Force
      shell: powershell
      
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache Cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Install WebView2 Runtime
      shell: powershell
      run: |
        try {
          winget install --id Microsoft.EdgeWebView2Runtime --silent --accept-package-agreements --accept-source-agreements
        } catch {
          Write-Host "WebView2 already installed or installation skipped"
        }
        exit 0
        
    - name: Install Visual C++ Redistributable
      shell: powershell
      run: |
        try {
          winget install --id Microsoft.VCRedist.2015+.x64 --silent --accept-package-agreements --accept-source-agreements
        } catch {
          Write-Host "VC++ Redistributable already installed or installation skipped"
        }
        exit 0
        
    - name: Install frontend dependencies
      run: npm ci
      
    - name: Build frontend
      run: npm run build
      
    - name: Install Tesseract OCR (REQUIRED for PDF scanning)
      shell: powershell
      run: |
        Write-Host "üì¶ Installing Tesseract OCR for PDF scanning..."
        
        # Install Tesseract with Portuguese language data
        winget install --id UB-Mannheim.TesseractOCR --silent --accept-package-agreements --accept-source-agreements
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "‚ùå Tesseract installation failed! Trying alternative method..."
          
          # Alternative: Direct download and install
          $tesseractUrl = "https://digi.bib.uni-mannheim.de/tesseract/tesseract-ocr-w64-setup-5.3.3.20231005.exe"
          $installerPath = "$env:TEMP\tesseract-setup.exe"
          
          Write-Host "Downloading Tesseract from $tesseractUrl..."
          Invoke-WebRequest -Uri $tesseractUrl -OutFile $installerPath
          
          Write-Host "Installing Tesseract..."
          Start-Process -FilePath $installerPath -ArgumentList "/S" -Wait
          
          Remove-Item $installerPath -Force
        }
        
        # Verify installation
        $tesseractPath = "C:\Program Files\Tesseract-OCR\tesseract.exe"
        if (Test-Path $tesseractPath) {
          Write-Host "‚úÖ Tesseract OCR installed successfully"
          & $tesseractPath --version
          
          # Add to PATH for build
          $env:PATH = "C:\Program Files\Tesseract-OCR;$env:PATH"
          echo "C:\Program Files\Tesseract-OCR" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        } else {
          Write-Host "‚ö†Ô∏è Tesseract not found at expected location"
        }
        
    - name: Build Tauri app
      uses: tauri-apps/tauri-action@v0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        CARGO_INCREMENTAL: 0
      with:
        tagName: ${{ github.ref_name }}
        releaseName: 'ARKIVE Desktop v__VERSION__'
        releaseBody: |
          Sistema de Gerenciamento de Documentos Empresarial
          
          ## Instala√ß√£o Windows
          - Execute o arquivo MSI para instala√ß√£o autom√°tica
          - Ou use o instalador NSIS se preferir
          
          ## Recursos
          - Interface nativa Windows com WebView2
          - Processamento OCR offline de documentos
          - Sistema de busca FTS5 instant√¢neo
          - Trilha de auditoria completa e imut√°vel
          - Backup e sincroniza√ß√£o de dados
          
          ## Depend√™ncias
          - Windows 10/11
          - WebView2 Runtime (instalado automaticamente)
          - Visual C++ Redistributable (instalado automaticamente)
        releaseDraft: true
        prerelease: false
        includeDebug: false
        
    - name: Upload MSI Installer
      uses: actions/upload-artifact@v4
      with:
        name: arkive-windows-msi
        path: src-tauri/target/release/bundle/msi/*.msi
        
    - name: Upload NSIS Installer  
      uses: actions/upload-artifact@v4
      with:
        name: arkive-windows-nsis
        path: src-tauri/target/release/bundle/nsis/*.exe
        
    - name: Generate Installation Report
      shell: powershell
      run: |
        $report = @"
        # ARKIVE Desktop Build Report
        
        ## Build Status: SUCCESS ‚úÖ
        
        ### Artifacts Generated:
        - MSI Installer: Windows Installer Package
        - NSIS Installer: Self-extracting executable
        
        ### Installation Instructions:
        1. Download MSI or NSIS installer from artifacts
        2. Run as administrator if needed
        3. Dependencies (WebView2, VC++ Redist) installed automatically
        4. Launch ARKIVE from Start Menu or Desktop
        
        ### System Requirements:
        - Windows 10 version 1909 or later
        - Windows 11 (all versions)
        - 4GB RAM minimum, 8GB recommended
        - 500MB disk space for application
        
        Build completed: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        "@
        
        $report | Out-File -FilePath "build-report.md" -Encoding UTF8
        Write-Host $report
        
    - name: Upload Build Report
      uses: actions/upload-artifact@v4
      with:
        name: build-report
        path: build-report.md