name: Build ARKIVE Desktop for Windows

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Enable Git long paths
      run: git config --global core.longpaths true
      
    - name: Enable Windows long paths support
      run: |
        New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" `
          -Name "LongPathsEnabled" -Value 1 -PropertyType DWORD -Force
      shell: powershell
      
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache Cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Install WebView2 Runtime
      run: |
        winget install --id Microsoft.EdgeWebView2Runtime --silent --accept-package-agreements --accept-source-agreements
        
    - name: Install Visual C++ Redistributable
      run: |
        winget install --id Microsoft.VCRedist.2015+.x64 --silent --accept-package-agreements --accept-source-agreements
        
    - name: Install frontend dependencies
      run: npm ci
      
    - name: Build frontend
      run: npm run build
      
    - name: Install Tauri dependencies (optional OCR)
      shell: powershell
      run: |
        # Tentar instalar Tesseract OCR (opcional)
        try {
          winget install --id UB-Mannheim.TesseractOCR --silent --accept-package-agreements --accept-source-agreements
        } catch {
          Write-Host "Tesseract installation failed - OCR will use fallback"
        }
        
    - name: Build Tauri app
      uses: tauri-apps/tauri-action@v0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        CARGO_INCREMENTAL: 0
      with:
        tagName: ${{ github.ref_name }}
        releaseName: 'ARKIVE Desktop v__VERSION__'
        releaseBody: |
          Sistema de Gerenciamento de Documentos Empresarial
          
          ## Instalação Windows
          - Execute o arquivo MSI para instalação automática
          - Ou use o instalador NSIS se preferir
          
          ## Recursos
          - Interface nativa Windows com WebView2
          - Processamento OCR offline de documentos
          - Sistema de busca FTS5 instantâneo
          - Trilha de auditoria completa e imutável
          - Backup e sincronização de dados
          
          ## Dependências
          - Windows 10/11
          - WebView2 Runtime (instalado automaticamente)
          - Visual C++ Redistributable (instalado automaticamente)
        releaseDraft: true
        prerelease: false
        includeDebug: false
        
    - name: Upload MSI Installer
      uses: actions/upload-artifact@v3
      with:
        name: arkive-windows-msi
        path: src-tauri/target/release/bundle/msi/*.msi
        
    - name: Upload NSIS Installer  
      uses: actions/upload-artifact@v3
      with:
        name: arkive-windows-nsis
        path: src-tauri/target/release/bundle/nsis/*.exe
        
    - name: Generate Installation Report
      shell: powershell
      run: |
        $report = @"
        # ARKIVE Desktop Build Report
        
        ## Build Status: SUCCESS ✅
        
        ### Artifacts Generated:
        - MSI Installer: Windows Installer Package
        - NSIS Installer: Self-extracting executable
        
        ### Installation Instructions:
        1. Download MSI or NSIS installer from artifacts
        2. Run as administrator if needed
        3. Dependencies (WebView2, VC++ Redist) installed automatically
        4. Launch ARKIVE from Start Menu or Desktop
        
        ### System Requirements:
        - Windows 10 version 1909 or later
        - Windows 11 (all versions)
        - 4GB RAM minimum, 8GB recommended
        - 500MB disk space for application
        
        Build completed: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        "@
        
        $report | Out-File -FilePath "build-report.md" -Encoding UTF8
        Write-Host $report
        
    - name: Upload Build Report
      uses: actions/upload-artifact@v3
      with:
        name: build-report
        path: build-report.md