name: Build ARKIVE Desktop

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Security audit (Node)
      run: npm audit --audit-level=high

    - name: Build frontend
      run: npm run build

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: 1.89

    - name: Install cargo-audit (with fallback)
      run: cargo install cargo-audit || cargo audit --version

    - name: Security audit (Rust)
      run: cargo audit

    - name: Rust cache
      uses: swatinem/rust-cache@v2
      with:
        workspaces: "./src-tauri -> target"

    - name: Validate signing requirements for releases
      if: github.event_name == 'release'
      run: |
        if ("${{ secrets.WINDOWS_CERT_P12_BASE64 }}" -eq "") {
          Write-Error "ERRO: Release requer assinatura digital - configure WINDOWS_CERT_P12_BASE64"
          exit 1
        }
        Write-Output "âœ… Certificado de assinatura encontrado"
      shell: powershell

    - name: Install Tauri CLI
      run: npm install -g @tauri-apps/cli@2.0.0

    - name: Build Tauri app
      run: tauri build --bundles msi nsis
      env:
        TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
        TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

    - name: Sign Windows executables
      if: github.event_name == 'release'
      run: |
        # Decodificar certificado
        $certBytes = [System.Convert]::FromBase64String("${{ secrets.WINDOWS_CERT_P12_BASE64 }}")
        [System.IO.File]::WriteAllBytes("cert.p12", $certBytes)
        
        # Assinar todos os executÃ¡veis
        Get-ChildItem -Path "src-tauri\target\release\bundle\" -Recurse -Include "*.exe","*.msi" | ForEach-Object {
          Write-Output "ğŸ” Assinando: $($_.Name)"
          & signtool sign /f cert.p12 /p "${{ secrets.WINDOWS_CERT_PASSWORD }}" /tr http://timestamp.digicert.com /td sha256 /fd sha256 "$($_.FullName)"
          if ($LASTEXITCODE -ne 0) {
            Write-Error "âŒ Falha ao assinar $($_.Name)"
            exit 1
          }
          Write-Output "âœ… $($_.Name) assinado com sucesso"
        }
        
        # Remover certificado
        Remove-Item cert.p12
        Write-Output "ğŸ”’ Certificado removido do ambiente"
      shell: powershell

    - name: Create release package
      run: |
        mkdir release-package
        # Copiar executÃ¡veis
        Get-ChildItem -Path "src-tauri\target\release\bundle\msi\*.msi" | Copy-Item -Destination "release-package\"
        Get-ChildItem -Path "src-tauri\target\release\bundle\nsis\*.exe" | Copy-Item -Destination "release-package\"
        
        # Status da assinatura
        $isSignedText = if ("${{ secrets.WINDOWS_CERT_P12_BASE64 }}" -ne "") { "âœ… ASSINADOS DIGITALMENTE" } else { "âš ï¸ NÃƒO ASSINADOS" }
        
        # Criar arquivo de instruÃ§Ãµes
        @"
ğŸš€ ARKIVE Desktop - Instalador Profissional
==========================================

ğŸ“¦ OPÃ‡Ã•ES DE INSTALAÃ‡ÃƒO:

OPÃ‡ÃƒO 1: Instalador NSIS (Recomendado)
- Execute: ARKIVE - Guardou, Achou!_1.0.0_x64-setup.exe
- âœ… InstalaÃ§Ã£o automÃ¡tica com todas as dependÃªncias

OPÃ‡ÃƒO 2: Instalador MSI (Windows corporativo)
- Execute: ARKIVE - Guardou, Achou!_1.0.0_x64.msi
- âœ… Para ambientes corporativos com GPO

ğŸ”§ REQUISITOS MÃNIMOS:
- Windows 10 versÃ£o 1903 ou superior
- WebView2 Runtime (instalado automaticamente)
- 100 MB de espaÃ§o livre

ğŸ”’ SEGURANÃ‡A:
- ExecutÃ¡veis: $isSignedText
- âœ… Auditoria de seguranÃ§a aprovada
- âœ… CÃ³digo-fonte verificÃ¡vel em GitHub
- âœ… Dados locais criptografados
- âœ… Sem dependÃªncias externas em runtime

ğŸ“Š DADOS LOCAIS:
- ğŸ” SQLite com bcrypt
- ğŸ‘¤ Dados isolados por usuÃ¡rio
- ğŸ’¾ Backup automÃ¡tico local

Build: #${{ github.run_number }}
VersÃ£o: 1.0.0
"@ | Out-File -FilePath "release-package\LEIA-ME.txt" -Encoding UTF8
      shell: powershell

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: arkive-desktop-${{ github.run_number }}
        path: release-package/
        retention-days: 30

    - name: Upload to release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: release-package/*
        tag_name: ${{ github.ref_name }}
        name: ğŸš€ ARKIVE Desktop v${{ github.ref_name }}
        body: |
          ## ğŸ† ARKIVE Desktop - Release Oficial
          
          ### ğŸ”’ SeguranÃ§a Enterprise Verificada
          - âœ… **Auditoria completa**: 0 CVEs crÃ­ticos encontrados
          - âœ… **ExecutÃ¡veis assinados**: Certificado digital vÃ¡lido
          - âœ… **Dados criptografados**: SQLite + bcrypt
          - âœ… **PermissÃµes mÃ­nimas**: Acesso restrito
          - âœ… **CSP rigoroso**: ProteÃ§Ã£o contra XSS
          
          ### ğŸ“¦ Instaladores DisponÃ­veis
          - **ğŸ¯ NSIS Setup**: InstalaÃ§Ã£o automÃ¡tica (recomendado)
          - **ğŸ¢ MSI Package**: Para ambientes corporativos
          
          ### ğŸš€ Funcionalidades
          - ğŸ“ GestÃ£o completa de documentos
          - ğŸ” Multi-usuÃ¡rio com isolamento de dados
          - ğŸ¨ Interface moderna (claro/escuro)
          - âš¡ Performance otimizada (Rust + Tauri)
          - ğŸ’¾ Backup automÃ¡tico criptografado
          - ğŸ” Busca avanÃ§ada por conteÃºdo
          
          ### ğŸ“‹ Requisitos
          - Windows 10 versÃ£o 1903+
          - 4 GB RAM (recomendado: 8 GB)
          - 500 MB espaÃ§o livre
          - WebView2 Runtime (incluÃ­do)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
